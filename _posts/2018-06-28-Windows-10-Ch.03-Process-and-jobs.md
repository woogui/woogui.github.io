---
layout: post
title: Windows 10 프로세스와 잡
---

##프로세스 생성
윈도우 API에서는 프로세스 생성을 위한 여러 함수를 제공한다. 가장 간단한 함수로 CreateProcess가 있다.
프로세스 생성의 주요 단계는 다음 그림과 같다.
![](https://i.imgur.com/9TuJTI6.jpg "프로세스 생성의 주요 단계")

* 윈도우 8과 윈도우 서버 2012에서부터 최신 앱 또는 UWP 앱의 생성도 가능해 졌는데 최신 애플리케이션 프로세스를 생성하는 것은 CreateProcess를 호출하는 것 이외의 추가적인 조건이 필요하다.
* 익스큐티브는 네이티브 프로세스, 최소 프로세스, 피코 프로세스 같은 윈도우 API를 우회해 시작되야하는 추가적인 종류의 프로세스를 지원한다.
	* 최소 프로세스 : 유저 모드 주소 공간이 설정되지 않고, PEB 관련 구조체도 존재하지 않으며, NTDLL이 프로세스에 맵핑되지 않고, 로도/API 세트 정보도 맵핑되지 않는다. 또한 섹션 객체가 프로세스에 연관되지 않으며, Minimsl 플래그는 EPROCESS 플래그에 설정되어 TEB나 유저 모드 스택 같은 유저 모드 할당을 방지하도록 프로세스가 생성된다.
	* 피코 프로세스 : 피코 공급자로 불리는 특수한 컴포넌트로 하여 운영체제 관점에서 피코 프로세스 실행에 관한 대부분을 제어하게 하여 리눅스 용도의 SQL 서버 지원 등의 용도로 사용된다.
* 보호 프로세스 는 어떤 애플리케이션에 의해서든 생성될 수 있지만 운영체제가 이미지 파일이 특수한 윈도우 미디어 인증서로 디지털 서명이 이뤄진 경우에만 프로세스가 보호되게 하며, 정상적인 프로세스와 함께 존재하지만 여타 프로세스가 요청할 수 있는 접근 권한에 상당한 제약을 둘 수 있다.
	* 보호 프로세스 라이트(PPL) : 윈도우 8.1과 윈도우 서버 2012 R2 부터 보호 프로세스 라이트 라는 보호프로세스 모델의 확장이 도입 되었다.
* 트러스트릿(안전한 프로세스) : 트러스트릿은 하이퍼바이저를 이용해 운영체제와 유저 데이터의 안전성을 향상 시킨다.

##프로세스 내부 구조
모든 윈도우 프로세스는 익스큐티브 프로세스(EPROCESS) 구조체로 표현된다. 
![](https://i.imgur.com/fdy1bqw.jpg "익스큐티브 프로세스 구조체의 주요 필드")
EPROCESS의 구조체는 위 그림과 같은 주요 필드를 갖고
![](https://i.imgur.com/fLBoVBN.jpg "커널 프로세스 구조체의 주요 필드")
EPROCESS 구조체의 첫번째 필드인 KPROCESS구조체는 위 그림과 같은 핵심 필드를 갖는다.

##프로세스 종료
프로세스는 종료를 요청하는 지신만이 호출할 수 있는 ExitProcess 함수를 호출해 종료할 수 있고, TerminateProcess함수를 통해 강제 종료시킬 수도 있다. 프로세스가 어떻게 종료하든 누수는 없어야한다.

##이미지 로더
이미지 로더는 유저 모드 시스템 DLL인 Ntdll.dll 내에 존재하며, 커널라이브러리가 아니기 때문에 표준코드처럼 동작하고, 메모리 접근과 보안권한 측면에서 동일한 제약을 받는다.

* 이미지 로더가 책임지는 작업은 다음과 같다.
	* 애플리케이션을 위한 유저 모드 상태를 초기화한다.
	* 애플리케이션이 필요로 하는 모든 DLL을 찾기 위해 애플리케이션의 IAT을 파싱하고 DLL의 IAT를 재귀적으로 파싱한다. 그리고 함수가 실제 존재함을 확인하기 위해 DLL의 익스포트 테이블 파싱을 한다.
	* 요구가 있을 때뿐만 아니라 실행 시에도 DLL을 로딩/언로딩하고 로드된 모든 모듈을 관리한다.
	* 윈도우 SxS 지원에 필요한 매니페스트 파일과 다중 언어 유저 인터페이스 파일, 자원을 관리한다.
	* 심에 대한 애플리케이션 호환헝 데이터베이스를 읽고서 필요하다면 심 엔진 DLL을 로드한다.
	* 범용 윈도우 플랫폼 애플리케이션 작성을 허용하는 원코어 기능의 핵심 부분인 API세트와 API를 위한 리디렉션 지원을 활성화한다.
	* 심 엔진 및 애플리케이션 검증 메커니즘과 인터페이스할 뿐만 아니라 Switch-Branch 매커니즘을 통한 동적 런타임 호환성 미티게이션을 활성화한다.\

##잡
잡은 이름이 있고 보안성이 있으며 공유할 수 있는 커널 객체로서 하나 이상의 프로세스를 그룹으로 묶어 관리할 수 있다.

* 잡은 다음과 같이 시스템 매커니즘에 중요한 역할을 한다.
	* 최신 앱(UWP 프로세스)을 관리한다.
	* 실로라는 메커니즘을 통해 윈도우 컨테이너 지원을 구현하는 데 사용된다.
	* 데스크톱 행위 조정자는 주로 잡을 이용해 스로틀링과 타이머 가상화, 타이머 프리징, Win32 애플리케이션과 서비스에 관한 여타 유휴 유발 행위를 관리한다.
	* 동적 공정분배 스케줄링 그룹 스케줄링을 정의하고 관리하게 해준다.
	* 커스텀 메모리 분할의 세부적 사항을 가능하게 해준다.
	* Run as와 애플리케이션 박싱, 프로그램 호환성 관리자 같은 기능에 대한 핵심 활성자 역할을 한다.
	* 윈도우 관리 도구 여총을 통한 서비스 거부 공격으로부터의 미티게이션뿐만 아니라 애플리케이션에 대해 부분적인 보안 샌드박스를 제공한다.

* 잡 제약 : 잡에 가할 수 있는 CPU 관련 메모리, I/O 관련 제약들
	*  활성 프로세스의 최대 개수
	*  잡 전역적인 유저 모드 CPU 시간제한
	*  프로세스별 유저 모드 CPU 시간제한
	*  잡 프로세서 친화성
	*  잡 그룹 친화성
	*  잡 프로세스 우선순위 클래스
	*  기본 워킹셋 최댓값과 최솟값
	*  프로세스와 잡에 의해 할당된 가상 메모리 제한
	*  CPU 사용률 제어
	*  네트워크 대역폭 제어
	*  디스크 I/O 대역폭 제어

* 중첩 잡 : 윈도우 8과 윈도우 서버 2012부터 프로세스는 다수의 잡과 연관될 수 있었으며, 이는 잡 계층을 효과적으로 만들었다.